# Attach IAM Role with Inline Policy Using Terraform

The Nautilus DevOps team is setting up IAM-based access control for internal AWS resources. They need to create an IAM Role and an IAM Policy using Terraform and attach the policy to the role.

1. Create an IAM Role named `xfusion-role`.

2. Create an IAM Policy named `xfusion-policy` that allows listing EC2 instances.

3. Attach the policy to the role

4. Create the `main.tf` file (do not create a separate `.tf` file) to provision a Role, policy and attach it.

5. Use the `variables.tf` file with the following:
   - `KKE_ROLE_NAME`: name of the role.
   - `KKE_POLICY_NAME`: name of the policy.

6. Use `terraform.tfvarsfile` to input the role and policy names.

7. Use outputs.tf file to output the following:
   - `kke_iam_role_name`: name of the role created.
   - `kke_iam_policy_name`: name of the policy ceated.

**`/home/bob/terraform/main.tf`**

```hcl
resource "aws_iam_role" "kke_role" {
  name = var.KKE_ROLE_NAME

  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Principal = {
          Service = "ec2.amazonaws.com"
        }
        Action = "sts:AssumeRole"
      }
    ]
  })
}

resource "aws_iam_policy" "kke_policy" {
  name        = var.KKE_POLICY_NAME
  description = "Policy to allow listing EC2 instances"

  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect   = "Allow"
        Action   = [
          "ec2:DescribeInstances"
        ]
        Resource = "*"
      }
    ]
  })
}

resource "aws_iam_role_policy_attachment" "kke_attach" {
  role       = aws_iam_role.kke_role.name
  policy_arn = aws_iam_policy.kke_policy.arn
}
```

**`/home/bob/terraform/variables.tf`**

```hcl
variable "KKE_ROLE_NAME" {
  description = "Name of the IAM Role"
  type        = string
}

variable "KKE_POLICY_NAME" {
  description = "Name of the IAM Policy"
  type        = string
}
```

**`/home/bob/terraform/outputs.tf`**

```hcl
KKE_ROLE_NAME   = "xfusion-role"
KKE_POLICY_NAME = "xfusion-policy"
```

**`/home/bob/terraform/terraform.tfvars`**

```hcl
output "kke_iam_role_name" {
  description = "Name of the IAM Role created"
  value       = aws_iam_role.kke_role.name
}

output "kke_iam_policy_name" {
  description = "Name of the IAM Policy created"
  value       = aws_iam_policy.kke_policy.name
}
```

## How to apply

```bash
terraform init
terraform apply -auto-approve
terraform plan
```
