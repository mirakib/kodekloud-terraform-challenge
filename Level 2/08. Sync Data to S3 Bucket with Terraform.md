# Sync Data to S3 Bucket with Terraform

As a member of the Nautilus DevOps Team, your task is to perform the following using Terraform:

1. Create a New Private S3 Bucket: Name the bucket `devops-sync-4106` and store this bucket name in a variable named `KKE_BUCKET`.

2. Data Migration: Migrate all data from the existing `devops-s3-23337` bucket to the new `devops-sync-4106` bucket.

3. Ensure Data Consistency: Ensure that both buckets contain the same data after migration.

4. Update the `main.tf` file (do not create a separate `.tf` file) to provision a new private S3 bucket and migrate the data.

5. Use the variables.tf file with the following variable:
   - `KKE_BUCKET`: The name for the new bucket created.

6. Use the outputs.tf file with the following outputs:
  - `new_kke_bucket_name`: The name of the new bucket created.
  - `new_kke_bucket_acl`: The ACL of the new bucket created.

**`/home/bob/terraform/main.tf`**

```hcl
resource "aws_s3_bucket" "wordpress_bucket" {
  bucket = "devops-s3-23337"
}

resource "aws_s3_bucket_acl" "wordpress_bucket_acl" {
  bucket = aws_s3_bucket.wordpress_bucket.id
  acl    = "private"
}

# New Bucket
resource "aws_s3_bucket" "kke_bucket" {
  bucket = var.KKE_BUCKET
}

resource "aws_s3_bucket_acl" "kke_bucket_acl" {
  bucket = aws_s3_bucket.kke_bucket.id
  acl    = "private"
}

# Copy all objects from old bucket to new bucket
resource "null_resource" "s3_migration" {

  provisioner "local-exec" {
    command = "aws --endpoint-url=http://aws:4566 s3 sync s3://devops-s3-23337 s3://${var.KKE_BUCKET}"
  }

  depends_on = [
    aws_s3_bucket.kke_bucket
  ]
}
```

**`/home/bob/terraform/variables.tf`**

```hcl
variable "KKE_BUCKET" {
  description = "The name for the new bucket created"
  type        = string
  default     = "devops-sync-4106"
}
```

**`/home/bob/terraform/outputs.tf`**


```hcl
output "new_kke_bucket_name" {
  description = "The name of the new bucket created"
  value       = aws_s3_bucket.kke_bucket.bucket
}

output "new_kke_bucket_acl" {
  description = "The ACL of the new bucket created"
  value       = aws_s3_bucket_acl.kke_bucket_acl.acl
}
```

## How to apply

```bash
terraform init
terraform apply -auto-approve
terraform plan
```
